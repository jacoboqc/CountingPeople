---
title: "Static report"
author: "Mauro"
date: "6 4 2017"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = F, message = F, warning = F)
```

# Whole data mac count
```{r}
source("./static-analysis.R")
 mac_data <- read_capture_file("./Captura_Peritos.csv").
# mac_data <- read_capture_server("http://ec2-54-72-240-166.eu-west-1.compute.amazonaws.com:3000/macs")
fixed_data <- filter(mac_data, type == "fixed")
#> names(fixed_data)
## [1] "mac"    "device" "ID"     "time"   "type"  
mac_distro <- mac_count_distribution(fixed_data, mac_col = "mac")
summary(mac_distro$mac_count)
```
Datta summary shows most macs appear few times, less than 80 times. Histogramm will we displayed according to this.
```{r}
q90 <- quantile(mac_distro$mac_count, probs = 0.9)
hist(filter(mac_distro, mac_count <= q90)$mac_count, xlab = "Mac appearances",
     main = "Mac count distribution")
```

# Macs per time interval. 
Plots devices inside the system, that is, different macs seen per interval. Per interval, as well as distribution -i.e, occupance distribution. Returns same results as IPYNotebook function origin_activity
```{r}
interval_mac_count <- count_macs_interval(fixed_data, "time", "mac", "45 sec")
plot_date_count(interval_mac_count, "time", "mac_count", "45 sec")
hist(interval_mac_count$mac_count, main = "System occupation Distribution")
# TODO: add legend (red = mean), function = plot histogramm with mean
abline(v = mean(interval_mac_count$mac_count), col = "red")
```

# New macs per interval
```{r}
new_macs_count <- count_new_macs_interval(fixed_data, "time", "mac", "45 sec")
plot_date_count(new_macs_count, "time", "mac_count", "45 secs")
```

## Cumsum
```{r}
new_macs_evolution <- new_macs_accumulated(new_macs_count, "mac_count", "time")
plot_date_count(new_macs_evolution, "time", "macs_inside", "45 sec", geom_line())
```
# Time between bursts. Distribution
```{r}
t_bursts <- time_between_bursts(fixed_data, "mac", "time")
# histograms and means need round values, not dates
t_bursts$t_burst <- as.numeric(t_bursts$t_burst)
hist(t_bursts$t_burst, main="Average time between bursts")
```

# How many devices are generating the random macs?
We will use a regression. We have previously obtained the average time between bursts for each mac. 

We need to obtain a threshold called T_avg. It should be the minimum time in which, on average, a device emits its mac only once. Therefore we can assume that all different macs in that interval correspond to different devices.

We are also asumming that devices do not emmit both kind of macs at the same time

We count random and fixed macs in each of the intervals, and pair the values as (N_random, N_fixed). A regression is applied to the whole set of pairs, thus obtaining the f(N_fixed) = devices_random

```{r}
T_avg <- mean(t_bursts$t_burst)
rounded_secs <- paste(round(T_avg), "secs")
# to eliminate those with t_burst = 0
type_count <- binned_mac_pairs(mac_data, "time", rounded_secs, t_bursts$mac)
random_fixed_reg <- lm(random ~ fixed, data = type_count)


```